<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|YaHei Consolas Hybrid:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="lingsamuel, plt, programming" />





  <link rel="alternate" href="/atom.xml" title="Hakurei Shrine" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Broomie of Hakurei Shrine.">
<meta property="og:type" content="website">
<meta property="og:title" content="Hakurei Shrine">
<meta property="og:url" content="https://lingsamuel.github.io/index.html">
<meta property="og:site_name" content="Hakurei Shrine">
<meta property="og:description" content="Broomie of Hakurei Shrine.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hakurei Shrine">
<meta name="twitter:description" content="Broomie of Hakurei Shrine.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lingsamuel.github.io/"/>





  <title> Hakurei Shrine </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-89095899-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hakurei Shrine</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">What a Shame.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/04/01/Algorithm_W/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/01/Algorithm_W/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-01T00:55:24+08:00">
                2017-04-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/04/01/Algorithm_W/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/04/01/Algorithm_W/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="译-Algorithm-W-Step-By-Step"><a href="#译-Algorithm-W-Step-By-Step" class="headerlink" title="(译) Algorithm W Step By Step"></a>(译) Algorithm W Step By Step</h1><p>原作者 Martin Grabmüller</p>
<p>代码注释/其他语言转写将在未来补充（也有可能永远不补充）。</p>
<h3 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h3><p>在这篇文章里，我们会用 Haskell 完整地实现用于 Hindley-Milner 多态类型推断(Hindley-Milner polymorphic type inference)的经典算法： W。</p>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>类型推断是一件很棘手的事情，也很难入门。因为大多数相关资料都是关于更加高深的话题的，例如 rank-N polymorphism，predicative/impredicative type systems，universal and existential types 等。我已经通过实际解决问题学到了一点东西，因此我决定写一篇关于类型推导的基础教程——实现一个最基础的类型推断算法，用于基本的类型检查（例如 ML 或者 Haskell）。</p>
<p>这里研究的类型推导算法是由 Milner 提出的 Algorithm W。[1]</p>
<p>有关此算法的变种、拓展或者更多信息，请参阅[2]。</p>
<p>本教程也受到[3]的启发。</p>
<h2 id="2-Algorithm-W"><a href="#2-Algorithm-W" class="headerlink" title="2. Algorithm W"></a>2. Algorithm W</h2><p>让我们从必须的 import 开始。为了表示环境（Environment，又名上下文 Context）以及替换（Substitution），我们需要 import Data.Map。类型变量的集合等将由 Data.Set 表示。</p>
<p>我们也需要一些 monad transformer，因此我们需要 import 关于 monad 的库。</p>
<p>Text.PrettyPrint 提供了一些让输出内容格式化并且缩进良好的方法，PrettyPrint 的代码在附录 A。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> qualiﬁed Data.Map <span class="keyword">as</span> Map</div><div class="line"><span class="keyword">import</span> qualiﬁed Data.Set <span class="keyword">as</span> Set</div><div class="line"></div><div class="line"><span class="keyword">import</span> Control.Monad.Error</div><div class="line"><span class="keyword">import</span> Control.Monad.Reader</div><div class="line"><span class="keyword">import</span> Control.Monad.State</div><div class="line"></div><div class="line"><span class="keyword">import</span> qualiﬁed Text.PrettyPrint <span class="keyword">as</span> PP</div></pre></td></tr></table></figure>
<h3 id="2-1-准备"><a href="#2-1-准备" class="headerlink" title="2.1 准备"></a>2.1 准备</h3><p>我们先定义一些抽象语法，包括 expressions (Exp)，types (Type) 以及 type schemes (Scheme)。</p>
<p>Scheme ∀a1, …, an.t 表示的是一系列通用量化（Universal Quantifier）的多态类型变量。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Exp</span> = <span class="type">EVar</span> <span class="type">String</span></span></div><div class="line">        | <span class="type">ELit</span> <span class="type">Lit</span></div><div class="line">        | <span class="type">EApp</span> <span class="type">Exp</span> <span class="type">Exp</span></div><div class="line">        | <span class="type">EAbs</span> <span class="type">String</span> <span class="type">Exp</span></div><div class="line">        | <span class="type">ELet</span> <span class="type">String</span> <span class="type">Exp</span> <span class="type">Exp</span></div><div class="line">        <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Lit</span> = <span class="type">LInt</span> <span class="type">Integer</span></span></div><div class="line">        | <span class="type">LBool</span> <span class="type">Bool</span></div><div class="line">        <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Type</span> = <span class="type">TVar</span> <span class="type">String</span></span></div><div class="line">        | <span class="type">TInt</span></div><div class="line">        | <span class="type">TBool</span></div><div class="line">        | <span class="type">TFun</span> <span class="type">Type</span> <span class="type">Type</span></div><div class="line">        <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Scheme</span> = <span class="type">Scheme</span> [<span class="type">String</span>] <span class="type">Type</span></span></div></pre></td></tr></table></figure>
<p>为了提供可读的输出以及报错信息，我们定义了一些 pretty-printing 有关的方法（附录 A）。</p>
<p>我们需要确定类型的自由类型变量。ftv (free type variables) 方法实现了这一操作。我们会在 Types 这个类型类里实现这个方法，因为 type environments 也需要它（下文会提到）。另一个对 types, type schemes 等的有用操作是 apply 一个替换。一个替换仅仅替换自由类型变量，所以 type scheme 里的量化类型变量不受影响。</p>
 <figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Types</span> a <span class="keyword">where</span></span></div><div class="line">    ftv    ::  a -&gt; <span class="type">Set</span>.<span class="type">Set</span> <span class="type">String</span></div><div class="line">    apply  ::  <span class="type">Subst</span> -&gt; a -&gt; a</div><div class="line"><span class="class"></span></div><div class="line"><span class="keyword">instance</span> <span class="type">Types</span> <span class="type">Type</span> <span class="keyword">where</span></div><div class="line">    ftv (<span class="type">TVar</span> n)      =  <span class="type">Set</span>.singleton n</div><div class="line">    ftv <span class="type">TInt</span>          =  <span class="type">Set</span>.empty</div><div class="line">    ftv <span class="type">TBool</span>         =  <span class="type">Set</span>.empty</div><div class="line">    ftv (<span class="type">TFun</span> t1 t2)  =  ftv t1 `<span class="type">Set</span>.union` ftv t2</div><div class="line">    apply s (<span class="type">TVar</span> n)      =  <span class="keyword">case</span> <span class="type">Map</span>.lookup n s <span class="keyword">of</span></div><div class="line">                               <span class="type">Nothing</span>  -&gt; <span class="type">TVar</span> n</div><div class="line">                               <span class="type">Just</span> t   -&gt; t</div><div class="line">    apply s (<span class="type">TFun</span> t1 t2)  = <span class="type">TFun</span> (apply s t1) (apply s t2)</div><div class="line">    apply s t             =  t</div><div class="line"><span class="class"></span></div><div class="line"><span class="keyword">instance</span> <span class="type">Types</span> <span class="type">Scheme</span> <span class="keyword">where</span></div><div class="line">    ftv (<span class="type">Scheme</span> vars t)      =  (ftv t) `<span class="type">Set</span>.difference` (<span class="type">Set</span>.fromList vars)</div><div class="line">    apply s (<span class="type">Scheme</span> vars t)  =  <span class="type">Scheme</span> vars (apply (foldr <span class="type">Map</span>.delete s vars) t)</div></pre></td></tr></table></figure>
<p>如果把 types 方法扩展到列表有时是有用的。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Types</span> a =&gt; <span class="type">Types</span> [a] <span class="keyword">where</span></span></div><div class="line">    apply s  =  map (apply s)</div><div class="line">    ftv l    =  foldr <span class="type">Set</span>.union <span class="type">Set</span>.empty (map ftv l)</div></pre></td></tr></table></figure>
<p>现在我们定义替换，它被定义为一个有限长的类型变量到类型的映射。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">type</span> <span class="type">Subst</span> = <span class="type">Map</span>.<span class="type">Map</span> <span class="type">String</span> <span class="type">Type</span></span></div><div class="line"><span class="title">nullSubst</span>  ::  <span class="type">Subst</span></div><div class="line"><span class="title">nullSubst</span>  =   <span class="type">Map</span>.empty</div><div class="line"><span class="title">composeSubst</span>         :: <span class="type">Subst</span> -&gt; <span class="type">Subst</span> -&gt; <span class="type">Subst</span></div><div class="line"><span class="title">composeSubst</span> s1 s2   = (<span class="type">Map</span>.map (apply s1) s2) `<span class="type">Map</span>.union` s1</div></pre></td></tr></table></figure>
<p>Type environments，也就是 Γ，是一个从 term variables 到相应 type schemes 的映射。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">TypeEnv</span> = <span class="type">TypeEnv</span> (<span class="type">Map</span>.<span class="type">Map</span> <span class="type">String</span> <span class="type">Scheme</span>)</span></div></pre></td></tr></table></figure>
<p>我们定义一些有关 type environments 的方法。被称为 remove 的操作 Γ\x 移除 Γ 中有关 x 的绑定。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="title">remove</span>                    ::  <span class="type">TypeEnv</span> -&gt; <span class="type">String</span> -&gt; <span class="type">TypeEnv</span></div><div class="line"><span class="title">remove</span> (<span class="type">TypeEnv</span> env) var  =  <span class="type">TypeEnv</span> (<span class="type">Map</span>.delete var env)</div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Types</span> <span class="type">TypeEnv</span> <span class="keyword">where</span></span></div><div class="line">    ftv (<span class="type">TypeEnv</span> env)      =  ftv (<span class="type">Map</span>.elems env)</div><div class="line">    apply s (<span class="type">TypeEnv</span> env)  =  <span class="type">TypeEnv</span> (<span class="type">Map</span>.map (apply s) env)</div></pre></td></tr></table></figure>
<p>The function |generalize| abstracts a type over all type variables<br>which are free in the type but not free in the given type environment.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">generalize</span>        ::  <span class="type">TypeEnv</span> -&gt; <span class="type">Type</span> -&gt; <span class="type">Scheme</span></div><div class="line"><span class="title">generalize</span> env t  =   <span class="type">Scheme</span> vars t</div><div class="line">  <span class="keyword">where</span> vars = <span class="type">Set</span>.toList ((ftv t) `<span class="type">Set</span>.difference` (ftv env))</div></pre></td></tr></table></figure>
<p>Type scheme 实例化之类的操作，需要给新引入的类型变量一些新名称。通过合适的生成新名称的 monad 来实现这一想法。它同时还能传递 dynamically scoped environment，处理错误以及执行 I/O 操作。但这里暂时不介绍细节。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">TIEnv</span> = <span class="type">TIEnv</span>  &#123;&#125;</span></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">TIState</span> = <span class="type">TIState</span> &#123; <span class="title">tiSupply</span> :: <span class="type">Int</span> &#125;</span></div><div class="line"><span class="class"><span class="keyword">type</span> <span class="type">TI</span> a = <span class="type">ErrorT</span> <span class="type">String</span> (<span class="type">ReaderT</span> <span class="type">TIEnv</span> (<span class="type">StateT</span> <span class="type">TIState</span> <span class="type">IO</span>)) a</span></div><div class="line"><span class="title">runTI</span> :: <span class="type">TI</span> a -&gt; <span class="type">IO</span> (<span class="type">Either</span> <span class="type">String</span> a, <span class="type">TIState</span>)</div><div class="line"><span class="title">runTI</span> t = </div><div class="line">    <span class="keyword">do</span> (res, st) &lt;- runStateT (runReaderT (runErrorT t) initTIEnv) initTIState</div><div class="line">       return (res, st)</div><div class="line">  <span class="keyword">where</span> initTIEnv = <span class="type">TIEnv</span></div><div class="line">        initTIState = <span class="type">TIState</span>&#123;tiSupply = <span class="number">0</span>&#125;</div><div class="line"><span class="title">newTyVar</span> :: <span class="type">String</span> -&gt; <span class="type">TI</span> <span class="type">Type</span></div><div class="line"><span class="title">newTyVar</span> prefix =</div><div class="line">    <span class="keyword">do</span>  s &lt;- get</div><div class="line">        put s&#123;tiSupply = tiSupply s + <span class="number">1</span>&#125;</div><div class="line">        return (<span class="type">TVar</span>  (prefix ++ show (tiSupply s)))</div></pre></td></tr></table></figure>
<p>Instantiate 方法替换一个 type scheme 里所有的绑定类型变量为新的类型变量。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">instantiate</span> :: <span class="type">Scheme</span> -&gt; <span class="type">TI</span> <span class="type">Type</span></div><div class="line"><span class="title">instantiate</span> (<span class="type">Scheme</span> vars t) = <span class="keyword">do</span>  nvars &lt;- mapM (\ _ -&gt; newTyVar <span class="string">"a"</span>) vars</div><div class="line">                                  <span class="keyword">let</span> s = <span class="type">Map</span>.fromList (zip vars nvars)</div><div class="line">                                  return $ apply s t</div></pre></td></tr></table></figure>
<p>下面的是类型的 unification 方法。对于 t1 t2 两个类型，这个方法给出最通用（general）的合一（unifier）。<br>合一是一个替换S，它使得 S(t1) ≡ S(t2)。 方法 varBind 将一个类型变量绑定为一个类型，并且返回这个绑定的替换，并且不会将一个变量绑定到自身。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="title">mgu</span> :: <span class="type">Type</span> -&gt; <span class="type">Type</span> -&gt; <span class="type">TI</span> <span class="type">Subst</span></div><div class="line"><span class="title">mgu</span> (<span class="type">TFun</span> l r) (<span class="type">TFun</span> l' r')  =  <span class="keyword">do</span>  s1 &lt;- mgu l l'</div><div class="line">                                    s2 &lt;- mgu (apply s1 r) (apply s1 r')</div><div class="line">                                    return (s1 `composeSubst` s2)</div><div class="line"><span class="title">mgu</span> (<span class="type">TVar</span> u) t               =  varBind u t</div><div class="line"><span class="title">mgu</span> t (<span class="type">TVar</span> u)               =  varBind u t</div><div class="line"><span class="title">mgu</span> <span class="type">TInt</span> <span class="type">TInt</span>                =  return nullSubst</div><div class="line"><span class="title">mgu</span> <span class="type">TBool</span> <span class="type">TBool</span>              =  return nullSubst</div><div class="line"><span class="title">mgu</span> t1 t2                    =  throwError $ <span class="string">"types do not unify: "</span> ++ show t1 ++ </div><div class="line">                                <span class="string">" vs. "</span> ++ show t2</div><div class="line"><span class="title">varBind</span> :: <span class="type">String</span> -&gt; <span class="type">Type</span> -&gt; <span class="type">TI</span> <span class="type">Subst</span></div><div class="line"><span class="title">varBind</span> u t  | t == <span class="type">TVar</span> u           =  return nullSubst</div><div class="line">             | u `<span class="type">Set</span>.member` ftv t  =  throwError $ <span class="string">"occurs check fails: "</span> ++ u ++</div><div class="line">                                         <span class="string">" vs. "</span> ++ show t</div><div class="line">             | otherwise             =  return (<span class="type">Map</span>.singleton u t)</div></pre></td></tr></table></figure>
<h3 id="2-2-类型推断"><a href="#2-2-类型推断" class="headerlink" title="2.2 类型推断"></a>2.2 类型推断</h3><p>方法 tiLit 用于推断字面量。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">tiLit</span> :: <span class="type">Lit</span> -&gt; <span class="type">TI</span> (<span class="type">Subst</span>, <span class="type">Type</span>)</div><div class="line"><span class="title">tiLit</span> (<span class="type">LInt</span> _)   =  return (nullSubst, <span class="type">TInt</span>)</div><div class="line"><span class="title">tiLit</span> (<span class="type">LBool</span> _)  =  return (nullSubst, <span class="type">TBool</span>)</div></pre></td></tr></table></figure>
<p>方法 ti 用于推断表达式的类型。 Type environment 必须包含表达式里所有自由变量的绑定。返回值里记录了表达式里的类型约束的替换以及表达式的类型。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="title">ti</span>        ::  <span class="type">TypeEnv</span> -&gt; <span class="type">Exp</span> -&gt; <span class="type">TI</span> (<span class="type">Subst</span>, <span class="type">Type</span>)</div><div class="line"><span class="title">ti</span> (<span class="type">TypeEnv</span> env) (<span class="type">EVar</span> n) = </div><div class="line">    <span class="keyword">case</span> <span class="type">Map</span>.lookup n env <span class="keyword">of</span></div><div class="line">       <span class="type">Nothing</span>     -&gt;  throwError $ <span class="string">"unbound variable: "</span> ++ n</div><div class="line">       <span class="type">Just</span> sigma  -&gt;  <span class="keyword">do</span>  t &lt;- instantiate sigma</div><div class="line">                           return (nullSubst, t)</div><div class="line"><span class="title">ti</span> _ (<span class="type">ELit</span> l) = tiLit l</div><div class="line"><span class="title">ti</span> env (<span class="type">EAbs</span> n e) =</div><div class="line">    <span class="keyword">do</span>  tv &lt;- newTyVar <span class="string">"a"</span></div><div class="line">        <span class="keyword">let</span> <span class="type">TypeEnv</span> env' = remove env n</div><div class="line">            env'' = <span class="type">TypeEnv</span> (env' `<span class="type">Map</span>.union` (<span class="type">Map</span>.singleton n (<span class="type">Scheme</span> [] tv)))</div><div class="line">        (s1, t1) &lt;- ti env'' e</div><div class="line">        return (s1, <span class="type">TFun</span> (apply s1 tv) t1)</div><div class="line"><span class="title">ti</span> env exp@(<span class="type">EApp</span> e1 e2) =</div><div class="line">    <span class="keyword">do</span>  tv &lt;- newTyVar <span class="string">"a"</span></div><div class="line">        (s1, t1) &lt;- ti env e1</div><div class="line">        (s2, t2) &lt;- ti (apply s1 env) e2</div><div class="line">        s3 &lt;- mgu (apply s2 t1) (<span class="type">TFun</span> t2 tv)</div><div class="line">        return (s3 `composeSubst` s2 `composeSubst` s1, apply s3 tv)</div><div class="line">    `catchError`</div><div class="line">    \e -&gt; throwError $ e ++ <span class="string">"\n in "</span> ++ show exp</div><div class="line"><span class="title">ti</span> env (<span class="type">ELet</span> x e1 e2) =</div><div class="line">    <span class="keyword">do</span>  (s1, t1) &lt;- ti env e1</div><div class="line">        <span class="keyword">let</span> <span class="type">TypeEnv</span> env' = remove env x</div><div class="line">            t' = generalize (apply s1 env) t1</div><div class="line">            env'' = <span class="type">TypeEnv</span> (<span class="type">Map</span>.insert x t' env')</div><div class="line">        (s2, t2) &lt;- ti (apply s1 env'') e2</div><div class="line">        return (s1 `composeSubst` s2, t2)</div></pre></td></tr></table></figure>
<p>这是类型推断器的入口，只是简单地调用了 ti 并且将返回的替换应用到返回的类型上。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">typeInference</span> :: <span class="type">Map</span>.<span class="type">Map</span> <span class="type">String</span> <span class="type">Scheme</span> -&gt; <span class="type">Exp</span> -&gt; <span class="type">TI</span> <span class="type">Type</span></div><div class="line"><span class="title">typeInference</span> env e =</div><div class="line">    <span class="keyword">do</span>  (s, t) &lt;- ti (<span class="type">TypeEnv</span> env) e</div><div class="line">        return (apply s t)</div></pre></td></tr></table></figure>
<h3 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3 测试"></a>2.3 测试</h3><p>下面列出一些简单的表达式（部分取自[2]）用于测试这些方法。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="title">e0</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">EVar</span> <span class="string">"x"</span>))</div><div class="line">        (<span class="type">EVar</span> <span class="string">"id"</span>)</div><div class="line"><span class="title">e1</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">EVar</span> <span class="string">"x"</span>))</div><div class="line">        (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"id"</span>) (<span class="type">EVar</span> <span class="string">"id"</span>))</div><div class="line"><span class="title">e2</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">ELet</span> <span class="string">"y"</span> (<span class="type">EVar</span> <span class="string">"x"</span>) (<span class="type">EVar</span> <span class="string">"y"</span>)))</div><div class="line">        (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"id"</span>) (<span class="type">EVar</span> <span class="string">"id"</span>))</div><div class="line"><span class="title">e3</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">ELet</span> <span class="string">"y"</span> (<span class="type">EVar</span> <span class="string">"x"</span>) (<span class="type">EVar</span> <span class="string">"y"</span>)))</div><div class="line">        (<span class="type">EApp</span> (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"id"</span>) (<span class="type">EVar</span> <span class="string">"id"</span>)) (<span class="type">ELit</span> (<span class="type">LInt</span> <span class="number">2</span>)))</div><div class="line"><span class="title">e4</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"x"</span>) (<span class="type">EVar</span> <span class="string">"x"</span>)))</div><div class="line">        (<span class="type">EVar</span> <span class="string">"id"</span>)</div><div class="line"><span class="title">e5</span>  =  <span class="type">EAbs</span> <span class="string">"m"</span> (<span class="type">ELet</span> <span class="string">"y"</span> (<span class="type">EVar</span> <span class="string">"m"</span>)</div><div class="line">                 (<span class="type">ELet</span> <span class="string">"x"</span> (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"y"</span>) (<span class="type">ELit</span> (<span class="type">LBool</span> <span class="type">True</span>)))</div><div class="line">                       (<span class="type">EVar</span> <span class="string">"x"</span>)))</div><div class="line">       </div><div class="line"><span class="title">e6</span>  =  <span class="type">EApp</span> (<span class="type">ELit</span> (<span class="type">LInt</span> <span class="number">2</span>)) (<span class="type">ELit</span> (<span class="type">LInt</span> <span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>下面这个简单的测试函数试图推断给定表达式的类型。如果成功了，它将打印出这个表达式和它的类型，否则，打印错误信息。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="title">test</span> :: <span class="type">Exp</span> -&gt; <span class="type">IO</span> ()</div><div class="line"><span class="title">test</span> e =</div><div class="line">    <span class="keyword">do</span>  (res, _) &lt;- runTI (typeInference <span class="type">Map</span>.empty e)</div><div class="line">        <span class="keyword">case</span> res <span class="keyword">of</span></div><div class="line">          <span class="type">Left</span> err  -&gt;  putStrLn $ show e ++ <span class="string">"\n "</span> ++ err ++ <span class="string">"\n"</span></div><div class="line">          <span class="type">Right</span> t   -&gt;  putStrLn $ show e ++ <span class="string">" :: "</span> ++ show t ++ <span class="string">"\n"</span></div></pre></td></tr></table></figure>
<h3 id="2-4-Main"><a href="#2-4-Main" class="headerlink" title="2.4 Main"></a>2.4 Main</h3><p>Main 只是简单地推断了所有示例表达式并且将它们和所推导出来的类型一同打印出来，如果失败，将打印错误信息。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">main</span> :: <span class="type">IO</span> ()</div><div class="line"><span class="title">main</span> = mapM_ test [e0, e1, e2, e3, e4, e5, e6]</div><div class="line"><span class="comment">-- |Collecting Constraints|</span></div><div class="line"><span class="comment">-- |main = mapM_ test' [e0, e1, e2, e3, e4, e5]|</span></div></pre></td></tr></table></figure>
<p>这就是这个类型推导算法的全部实现了。</p>
<h2 id="3-结论"><a href="#3-结论" class="headerlink" title="3. 结论"></a>3. 结论</h2><p>这些 Haskell 代码是一个自包含的 Algorithm W 实现。你可以随意使用、扩展这些代码，让它能够支持更好的错误信息、类型类、类型注解等等。最终你也许会得到一个完整地 Haskell 的类型检查器。</p>
<h2 id="4-参考"><a href="#4-参考" class="headerlink" title="4. 参考"></a>4. 参考</h2><p>[1] Copied from <a href="http://www.grabmueller.de/martin/www/pub/AlgorithmW.en.html" target="_blank" rel="external">http://www.grabmueller.de/martin/www/pub/AlgorithmW.en.html</a> and edited by Wei Hu. Unfortunately the bibliography is missing. </p>
<p>[2] The most helpful references are <a href="http://www.cs.uu.nl/research/techreps/repo/CS-2002/2002-031.pdf" target="_blank" rel="external">http://www.cs.uu.nl/research/techreps/repo/CS-2002/2002-031.pdf</a> Generalizing Hindley-Milner Type Inference Algorithms, and Chapter 22 of TAPL.</p>
<p>[3] A Cornell course touchs on this topic and gives an OCaml implementation. <a href="http://www.cs.cornell.edu/Courses/cs3110/2009fa/lectures/lec26a.htm" target="_blank" rel="external">http://www.cs.cornell.edu/Courses/cs3110/2009fa/lectures/lec26a.htm</a></p>
<h2 id="附录-A"><a href="#附录-A" class="headerlink" title="附录 A"></a>附录 A</h2><p>本附录提供了 pretty-printing 方法和 type 的 Show 类型类实例。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Type</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prType x)</div><div class="line"><span class="title">prType</span>             ::  <span class="type">Type</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prType</span> (<span class="type">TVar</span> n)    =   <span class="type">PP</span>.text n</div><div class="line"><span class="title">prType</span> <span class="type">TInt</span>        =   <span class="type">PP</span>.text <span class="string">"Int"</span></div><div class="line"><span class="title">prType</span> <span class="type">TBool</span>       =   <span class="type">PP</span>.text <span class="string">"Bool"</span></div><div class="line"><span class="title">prType</span> (<span class="type">TFun</span> t s)  =   prParenType t <span class="type">PP</span>.&lt;+&gt; <span class="type">PP</span>.text <span class="string">"-&gt;"</span> <span class="type">PP</span>.&lt;+&gt; prType s</div><div class="line"><span class="title">prParenType</span>     ::  <span class="type">Type</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prParenType</span>  t  =   <span class="keyword">case</span> t <span class="keyword">of</span></div><div class="line">                      <span class="type">TFun</span> _ _  -&gt; <span class="type">PP</span>.parens (prType t)</div><div class="line">                      _         -&gt; prType t</div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Exp</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prExp x)</div><div class="line"><span class="title">prExp</span>                  ::  <span class="type">Exp</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prExp</span> (<span class="type">EVar</span> name)      =   <span class="type">PP</span>.text name</div><div class="line"><span class="title">prExp</span> (<span class="type">ELit</span> lit)       =   prLit lit</div><div class="line"><span class="title">prExp</span> (<span class="type">ELet</span> x b body)  =   <span class="type">PP</span>.text <span class="string">"let"</span> <span class="type">PP</span>.&lt;+&gt; </div><div class="line">                           <span class="type">PP</span>.text x <span class="type">PP</span>.&lt;+&gt; <span class="type">PP</span>.text <span class="string">"="</span> <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                           prExp b <span class="type">PP</span>.&lt;+&gt; <span class="type">PP</span>.text <span class="string">"in"</span> <span class="type">PP</span>.$$</div><div class="line">                           <span class="type">PP</span>.nest <span class="number">2</span> (prExp body)</div><div class="line"><span class="title">prExp</span> (<span class="type">EApp</span> e1 e2)     =   prExp e1 <span class="type">PP</span>.&lt;+&gt; prParenExp e2</div><div class="line"><span class="title">prExp</span> (<span class="type">EAbs</span> n e)       =   <span class="type">PP</span>.char '\\' <span class="type">PP</span>.&lt;&gt; <span class="type">PP</span>.text n <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                           <span class="type">PP</span>.text <span class="string">"-&gt;"</span> <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                           prExp e</div><div class="line">                                                                   </div><div class="line"><span class="title">prParenExp</span>    ::  <span class="type">Exp</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prParenExp</span> t  =   <span class="keyword">case</span> t <span class="keyword">of</span></div><div class="line">                    <span class="type">ELet</span> _ _ _  -&gt; <span class="type">PP</span>.parens (prExp t)</div><div class="line">                    <span class="type">EApp</span> _ _    -&gt; <span class="type">PP</span>.parens (prExp t)</div><div class="line">                    <span class="type">EAbs</span> _ _    -&gt; <span class="type">PP</span>.parens (prExp t)</div><div class="line">                    _           -&gt; prExp t</div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Lit</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prLit x)</div><div class="line"><span class="title">prLit</span>            ::  <span class="type">Lit</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prLit</span> (<span class="type">LInt</span> i)   =   <span class="type">PP</span>.integer i</div><div class="line"><span class="title">prLit</span> (<span class="type">LBool</span> b)  =   <span class="keyword">if</span> b <span class="keyword">then</span> <span class="type">PP</span>.text <span class="string">"True"</span> <span class="keyword">else</span> <span class="type">PP</span>.text <span class="string">"False"</span></div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Scheme</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prScheme x)</div><div class="line"><span class="title">prScheme</span>                  ::  <span class="type">Scheme</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prScheme</span> (<span class="type">Scheme</span> vars t)  =   <span class="type">PP</span>.text <span class="string">"All"</span> <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                              <span class="type">PP</span>.hcat </div><div class="line">                                (<span class="type">PP</span>.punctuate <span class="type">PP</span>.comma (map <span class="type">PP</span>.text vars))</div><div class="line">                              <span class="type">PP</span>.&lt;&gt; <span class="type">PP</span>.text <span class="string">"."</span> <span class="type">PP</span>.&lt;+&gt; prType t</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/03/19/Algorithm-W/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/19/Algorithm-W/" itemprop="url">
                  Algorithm W
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-19T17:07:50+08:00">
                2017-03-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/19/Algorithm-W/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/19/Algorithm-W/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="译-Algorithm-W-Step-By-Step"><a href="#译-Algorithm-W-Step-By-Step" class="headerlink" title="(译) Algorithm W Step By Step"></a>(译) Algorithm W Step By Step</h1><p>原作者 Martin Grabmüller</p>
<p>代码注释/其他语言转写将在未来补充（也有可能永远不补充）。</p>
<h3 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h3><p>在这篇文章里，我们会用 Haskell 完整地实现用于 Hindley-Milner 多态类型推断(Hindley-Milner polymorphic type inference)的经典算法： W。</p>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>类型推断是一件很棘手的事情，也很难入门。因为大多数相关资料都是关于更加高深的话题的，例如 rank-N polymorphism，predicative/impredicative type systems，universal and existential types 等。我已经通过实际解决问题学到了一点东西，因此我决定写一篇关于类型推导的基础教程——实现一个最基础的类型推断算法，用于基本的类型检查（例如 ML 或者 Haskell）。</p>
<p>这里研究的类型推导算法是由 Milner 提出的 Algorithm W。[1]</p>
<p>有关此算法的变种、拓展或者更多信息，请参阅[2]。</p>
<p>本教程也受到[3]的启发。</p>
<h2 id="2-Algorithm-W"><a href="#2-Algorithm-W" class="headerlink" title="2. Algorithm W"></a>2. Algorithm W</h2><p>让我们从必须的 import 开始。为了表示环境（Environment，又名上下文 Context）以及替换（Substitution），我们需要 import Data.Map。类型变量的集合等将由 Data.Set 表示。</p>
<p>我们也需要一些 monad transformer，因此我们需要 import 关于 monad 的库。</p>
<p>Text.PrettyPrint 提供了一些让输出内容格式化并且缩进良好的方法，PrettyPrint 的代码在附录 A。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">qualified</span> Data.Map <span class="keyword">as</span> Map</div><div class="line"><span class="keyword">import</span> <span class="keyword">qualified</span> Data.Set <span class="keyword">as</span> Set</div><div class="line"></div><div class="line"><span class="keyword">import</span> Control.Monad.Error</div><div class="line"><span class="keyword">import</span> Control.Monad.Reader</div><div class="line"><span class="keyword">import</span> Control.Monad.State</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">qualified</span> Text.PrettyPrint <span class="keyword">as</span> PP</div></pre></td></tr></table></figure>
<h3 id="2-1-准备"><a href="#2-1-准备" class="headerlink" title="2.1 准备"></a>2.1 准备</h3><p>我们先定义一些抽象语法，包括 expressions (Exp)，types (Type) 以及 type schemes (Scheme)。</p>
<p>Scheme ∀a1, …, an.t 表示的是一系列通用量化（Universal Quantifier）的多态类型变量。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Exp</span> = <span class="type">EVar</span> <span class="type">String</span></span></div><div class="line">        | <span class="type">ELit</span> <span class="type">Lit</span></div><div class="line">        | <span class="type">EApp</span> <span class="type">Exp</span> <span class="type">Exp</span></div><div class="line">        | <span class="type">EAbs</span> <span class="type">String</span> <span class="type">Exp</span></div><div class="line">        | <span class="type">ELet</span> <span class="type">String</span> <span class="type">Exp</span> <span class="type">Exp</span></div><div class="line">        <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Lit</span> = <span class="type">LInt</span> <span class="type">Integer</span></span></div><div class="line">        | <span class="type">LBool</span> <span class="type">Bool</span></div><div class="line">        <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Type</span> = <span class="type">TVar</span> <span class="type">String</span></span></div><div class="line">        | <span class="type">TInt</span></div><div class="line">        | <span class="type">TBool</span></div><div class="line">        | <span class="type">TFun</span> <span class="type">Type</span> <span class="type">Type</span></div><div class="line">        <span class="keyword">deriving</span> (<span class="type">Eq</span>, <span class="type">Ord</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">Scheme</span> = <span class="type">Scheme</span> [<span class="type">String</span>] <span class="type">Type</span></span></div></pre></td></tr></table></figure>
<p>为了提供可读的输出以及报错信息，我们定义了一些 pretty-printing 有关的方法（附录 A）。</p>
<p>我们需要确定类型的自由类型变量。ftv (free type variables) 方法实现了这一操作。我们会在 Types 这个类型类里实现这个方法，因为 type environments 也需要它（下文会提到）。另一个对 types, type schemes 等的有用操作是 apply 一个替换。一个替换仅仅替换自由类型变量，所以 type scheme 里的量化类型变量不受影响。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Types</span> a <span class="keyword">where</span></span></div><div class="line">    ftv    ::  a -&gt; <span class="type">Set</span>.<span class="type">Set</span> <span class="type">String</span></div><div class="line">    apply  ::  <span class="type">Subst</span> -&gt; a -&gt; a</div><div class="line"><span class="class"></span></div><div class="line"><span class="keyword">instance</span> <span class="type">Types</span> <span class="type">Type</span> <span class="keyword">where</span></div><div class="line">    ftv (<span class="type">TVar</span> n)      =  <span class="type">Set</span>.singleton n</div><div class="line">    ftv <span class="type">TInt</span>          =  <span class="type">Set</span>.empty</div><div class="line">    ftv <span class="type">TBool</span>         =  <span class="type">Set</span>.empty</div><div class="line">    ftv (<span class="type">TFun</span> t1 t2)  =  ftv t1 `<span class="type">Set</span>.union` ftv t2</div><div class="line">    apply s (<span class="type">TVar</span> n)      =  <span class="keyword">case</span> <span class="type">Map</span>.lookup n s <span class="keyword">of</span></div><div class="line">                               <span class="type">Nothing</span>  -&gt; <span class="type">TVar</span> n</div><div class="line">                               <span class="type">Just</span> t   -&gt; t</div><div class="line">    apply s (<span class="type">TFun</span> t1 t2)  = <span class="type">TFun</span> (apply s t1) (apply s t2)</div><div class="line">    apply s t             =  t</div><div class="line"><span class="class"></span></div><div class="line"><span class="keyword">instance</span> <span class="type">Types</span> <span class="type">Scheme</span> <span class="keyword">where</span></div><div class="line">    ftv (<span class="type">Scheme</span> vars t)      =  (ftv t) `<span class="type">Set</span>.difference` (<span class="type">Set</span>.fromList vars)</div><div class="line">    apply s (<span class="type">Scheme</span> vars t)  =  <span class="type">Scheme</span> vars (apply (foldr <span class="type">Map</span>.delete s vars) t)</div></pre></td></tr></table></figure>
<p>如果把 types 方法扩展到列表有时是有用的。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Types</span> a =&gt; <span class="type">Types</span> [a] <span class="keyword">where</span></span></div><div class="line">    apply s  =  map (apply s)</div><div class="line">    ftv l    =  foldr <span class="type">Set</span>.union <span class="type">Set</span>.empty (map ftv l)</div></pre></td></tr></table></figure>
<p>现在我们定义替换，它被定义为一个有限长的类型变量到类型的映射。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">type</span> <span class="type">Subst</span> = <span class="type">Map</span>.<span class="type">Map</span> <span class="type">String</span> <span class="type">Type</span></span></div><div class="line"><span class="title">nullSubst</span>  ::  <span class="type">Subst</span></div><div class="line"><span class="title">nullSubst</span>  =   <span class="type">Map</span>.empty</div><div class="line"><span class="title">composeSubst</span>         :: <span class="type">Subst</span> -&gt; <span class="type">Subst</span> -&gt; <span class="type">Subst</span></div><div class="line"><span class="title">composeSubst</span> s1 s2   = (<span class="type">Map</span>.map (apply s1) s2) `<span class="type">Map</span>.union` s1</div></pre></td></tr></table></figure>
<p>Type environments，也就是 Γ，是一个从 term variables 到相应 type schemes 的映射。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">TypeEnv</span> = <span class="type">TypeEnv</span> (<span class="type">Map</span>.<span class="type">Map</span> <span class="type">String</span> <span class="type">Scheme</span>)</span></div></pre></td></tr></table></figure>
<p>我们定义一些有关 type environments 的方法。被称为 remove 的操作 Γ\x 移除 Γ 中有关 x 的绑定。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="title">remove</span>                    ::  <span class="type">TypeEnv</span> -&gt; <span class="type">String</span> -&gt; <span class="type">TypeEnv</span></div><div class="line"><span class="title">remove</span> (<span class="type">TypeEnv</span> env) var  =  <span class="type">TypeEnv</span> (<span class="type">Map</span>.delete var env)</div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Types</span> <span class="type">TypeEnv</span> <span class="keyword">where</span></span></div><div class="line">    ftv (<span class="type">TypeEnv</span> env)      =  ftv (<span class="type">Map</span>.elems env)</div><div class="line">    apply s (<span class="type">TypeEnv</span> env)  =  <span class="type">TypeEnv</span> (<span class="type">Map</span>.map (apply s) env)</div></pre></td></tr></table></figure>
<p>The function |generalize| abstracts a type over all type variables<br>which are free in the type but not free in the given type environment.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">generalize</span>        ::  <span class="type">TypeEnv</span> -&gt; <span class="type">Type</span> -&gt; <span class="type">Scheme</span></div><div class="line"><span class="title">generalize</span> env t  =   <span class="type">Scheme</span> vars t</div><div class="line">  <span class="keyword">where</span> vars = <span class="type">Set</span>.toList ((ftv t) `<span class="type">Set</span>.difference` (ftv env))</div></pre></td></tr></table></figure>
<p>Type scheme 实例化之类的操作，需要给新引入的类型变量一些新名称。通过合适的生成新名称的 monad 来实现这一想法。它同时还能传递 dynamically scoped environment，处理错误以及执行 I/O 操作。但这里暂时不介绍细节。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">TIEnv</span> = <span class="type">TIEnv</span>  &#123;&#125;</span></div><div class="line"><span class="class"><span class="keyword">data</span> <span class="type">TIState</span> = <span class="type">TIState</span> &#123; <span class="title">tiSupply</span> :: <span class="type">Int</span> &#125;</span></div><div class="line"><span class="class"><span class="keyword">type</span> <span class="type">TI</span> a = <span class="type">ErrorT</span> <span class="type">String</span> (<span class="type">ReaderT</span> <span class="type">TIEnv</span> (<span class="type">StateT</span> <span class="type">TIState</span> <span class="type">IO</span>)) a</span></div><div class="line"><span class="title">runTI</span> :: <span class="type">TI</span> a -&gt; <span class="type">IO</span> (<span class="type">Either</span> <span class="type">String</span> a, <span class="type">TIState</span>)</div><div class="line"><span class="title">runTI</span> t = </div><div class="line">    <span class="keyword">do</span> (res, st) &lt;- runStateT (runReaderT (runErrorT t) initTIEnv) initTIState</div><div class="line">       return (res, st)</div><div class="line">  <span class="keyword">where</span> initTIEnv = <span class="type">TIEnv</span></div><div class="line">        initTIState = <span class="type">TIState</span>&#123;tiSupply = <span class="number">0</span>&#125;</div><div class="line"><span class="title">newTyVar</span> :: <span class="type">String</span> -&gt; <span class="type">TI</span> <span class="type">Type</span></div><div class="line"><span class="title">newTyVar</span> prefix =</div><div class="line">    <span class="keyword">do</span>  s &lt;- get</div><div class="line">        put s&#123;tiSupply = tiSupply s + <span class="number">1</span>&#125;</div><div class="line">        return (<span class="type">TVar</span>  (prefix ++ show (tiSupply s)))</div></pre></td></tr></table></figure>
<p>Instantiate 方法替换一个 type scheme 里所有的绑定类型变量为新的类型变量。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">instantiate</span> :: <span class="type">Scheme</span> -&gt; <span class="type">TI</span> <span class="type">Type</span></div><div class="line"><span class="title">instantiate</span> (<span class="type">Scheme</span> vars t) = <span class="keyword">do</span>  nvars &lt;- mapM (\ _ -&gt; newTyVar <span class="string">"a"</span>) vars</div><div class="line">                                  <span class="keyword">let</span> s = <span class="type">Map</span>.fromList (zip vars nvars)</div><div class="line">                                  return $ apply s t</div></pre></td></tr></table></figure>
<p>下面的是类型的 unification 方法。对于 t1 t2 两个类型，这个方法给出最通用（general）的合一（unifier）。<br>合一是一个替换S，它使得 S(t1) ≡ S(t2)。 方法 varBind 将一个类型变量绑定为一个类型，并且返回这个绑定的替换，并且不会将一个变量绑定到自身。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="title">mgu</span> :: <span class="type">Type</span> -&gt; <span class="type">Type</span> -&gt; <span class="type">TI</span> <span class="type">Subst</span></div><div class="line"><span class="title">mgu</span> (<span class="type">TFun</span> l r) (<span class="type">TFun</span> l' r')  =  <span class="keyword">do</span>  s1 &lt;- mgu l l'</div><div class="line">                                    s2 &lt;- mgu (apply s1 r) (apply s1 r')</div><div class="line">                                    return (s1 `composeSubst` s2)</div><div class="line"><span class="title">mgu</span> (<span class="type">TVar</span> u) t               =  varBind u t</div><div class="line"><span class="title">mgu</span> t (<span class="type">TVar</span> u)               =  varBind u t</div><div class="line"><span class="title">mgu</span> <span class="type">TInt</span> <span class="type">TInt</span>                =  return nullSubst</div><div class="line"><span class="title">mgu</span> <span class="type">TBool</span> <span class="type">TBool</span>              =  return nullSubst</div><div class="line"><span class="title">mgu</span> t1 t2                    =  throwError $ <span class="string">"types do not unify: "</span> ++ show t1 ++ </div><div class="line">                                <span class="string">" vs. "</span> ++ show t2</div><div class="line"><span class="title">varBind</span> :: <span class="type">String</span> -&gt; <span class="type">Type</span> -&gt; <span class="type">TI</span> <span class="type">Subst</span></div><div class="line"><span class="title">varBind</span> u t  | t == <span class="type">TVar</span> u           =  return nullSubst</div><div class="line">             | u `<span class="type">Set</span>.member` ftv t  =  throwError $ <span class="string">"occurs check fails: "</span> ++ u ++</div><div class="line">                                         <span class="string">" vs. "</span> ++ show t</div><div class="line">             | otherwise             =  return (<span class="type">Map</span>.singleton u t)</div></pre></td></tr></table></figure>
<h3 id="2-2-类型推断"><a href="#2-2-类型推断" class="headerlink" title="2.2 类型推断"></a>2.2 类型推断</h3><p>方法 tiLit 用于推断字面量。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">tiLit</span> :: <span class="type">Lit</span> -&gt; <span class="type">TI</span> (<span class="type">Subst</span>, <span class="type">Type</span>)</div><div class="line"><span class="title">tiLit</span> (<span class="type">LInt</span> _)   =  return (nullSubst, <span class="type">TInt</span>)</div><div class="line"><span class="title">tiLit</span> (<span class="type">LBool</span> _)  =  return (nullSubst, <span class="type">TBool</span>)</div></pre></td></tr></table></figure>
<p>方法 ti 用于推断表达式的类型。 Type environment 必须包含表达式里所有自由变量的绑定。返回值里记录了表达式里的类型约束的替换以及表达式的类型。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="title">ti</span>        ::  <span class="type">TypeEnv</span> -&gt; <span class="type">Exp</span> -&gt; <span class="type">TI</span> (<span class="type">Subst</span>, <span class="type">Type</span>)</div><div class="line"><span class="title">ti</span> (<span class="type">TypeEnv</span> env) (<span class="type">EVar</span> n) = </div><div class="line">    <span class="keyword">case</span> <span class="type">Map</span>.lookup n env <span class="keyword">of</span></div><div class="line">       <span class="type">Nothing</span>     -&gt;  throwError $ <span class="string">"unbound variable: "</span> ++ n</div><div class="line">       <span class="type">Just</span> sigma  -&gt;  <span class="keyword">do</span>  t &lt;- instantiate sigma</div><div class="line">                           return (nullSubst, t)</div><div class="line"><span class="title">ti</span> _ (<span class="type">ELit</span> l) = tiLit l</div><div class="line"><span class="title">ti</span> env (<span class="type">EAbs</span> n e) =</div><div class="line">    <span class="keyword">do</span>  tv &lt;- newTyVar <span class="string">"a"</span></div><div class="line">        <span class="keyword">let</span> <span class="type">TypeEnv</span> env' = remove env n</div><div class="line">            env'' = <span class="type">TypeEnv</span> (env' `<span class="type">Map</span>.union` (<span class="type">Map</span>.singleton n (<span class="type">Scheme</span> [] tv)))</div><div class="line">        (s1, t1) &lt;- ti env'' e</div><div class="line">        return (s1, <span class="type">TFun</span> (apply s1 tv) t1)</div><div class="line"><span class="title">ti</span> env exp@(<span class="type">EApp</span> e1 e2) =</div><div class="line">    <span class="keyword">do</span>  tv &lt;- newTyVar <span class="string">"a"</span></div><div class="line">        (s1, t1) &lt;- ti env e1</div><div class="line">        (s2, t2) &lt;- ti (apply s1 env) e2</div><div class="line">        s3 &lt;- mgu (apply s2 t1) (<span class="type">TFun</span> t2 tv)</div><div class="line">        return (s3 `composeSubst` s2 `composeSubst` s1, apply s3 tv)</div><div class="line">    `catchError`</div><div class="line">    \e -&gt; throwError $ e ++ <span class="string">"\n in "</span> ++ show exp</div><div class="line"><span class="title">ti</span> env (<span class="type">ELet</span> x e1 e2) =</div><div class="line">    <span class="keyword">do</span>  (s1, t1) &lt;- ti env e1</div><div class="line">        <span class="keyword">let</span> <span class="type">TypeEnv</span> env' = remove env x</div><div class="line">            t' = generalize (apply s1 env) t1</div><div class="line">            env'' = <span class="type">TypeEnv</span> (<span class="type">Map</span>.insert x t' env')</div><div class="line">        (s2, t2) &lt;- ti (apply s1 env'') e2</div><div class="line">        return (s1 `composeSubst` s2, t2)</div></pre></td></tr></table></figure>
<p>这是类型推断器的入口，只是简单地调用了 ti 并且将返回的替换应用到返回的类型上。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">typeInference</span> :: <span class="type">Map</span>.<span class="type">Map</span> <span class="type">String</span> <span class="type">Scheme</span> -&gt; <span class="type">Exp</span> -&gt; <span class="type">TI</span> <span class="type">Type</span></div><div class="line"><span class="title">typeInference</span> env e =</div><div class="line">    <span class="keyword">do</span>  (s, t) &lt;- ti (<span class="type">TypeEnv</span> env) e</div><div class="line">        return (apply s t)</div></pre></td></tr></table></figure>
<h3 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3 测试"></a>2.3 测试</h3><p>下面列出一些简单的表达式（部分取自[2]）用于测试这些方法。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="title">e0</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">EVar</span> <span class="string">"x"</span>))</div><div class="line">        (<span class="type">EVar</span> <span class="string">"id"</span>)</div><div class="line"><span class="title">e1</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">EVar</span> <span class="string">"x"</span>))</div><div class="line">        (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"id"</span>) (<span class="type">EVar</span> <span class="string">"id"</span>))</div><div class="line"><span class="title">e2</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">ELet</span> <span class="string">"y"</span> (<span class="type">EVar</span> <span class="string">"x"</span>) (<span class="type">EVar</span> <span class="string">"y"</span>)))</div><div class="line">        (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"id"</span>) (<span class="type">EVar</span> <span class="string">"id"</span>))</div><div class="line"><span class="title">e3</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">ELet</span> <span class="string">"y"</span> (<span class="type">EVar</span> <span class="string">"x"</span>) (<span class="type">EVar</span> <span class="string">"y"</span>)))</div><div class="line">        (<span class="type">EApp</span> (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"id"</span>) (<span class="type">EVar</span> <span class="string">"id"</span>)) (<span class="type">ELit</span> (<span class="type">LInt</span> <span class="number">2</span>)))</div><div class="line"><span class="title">e4</span>  =  <span class="type">ELet</span> <span class="string">"id"</span> (<span class="type">EAbs</span> <span class="string">"x"</span> (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"x"</span>) (<span class="type">EVar</span> <span class="string">"x"</span>)))</div><div class="line">        (<span class="type">EVar</span> <span class="string">"id"</span>)</div><div class="line"><span class="title">e5</span>  =  <span class="type">EAbs</span> <span class="string">"m"</span> (<span class="type">ELet</span> <span class="string">"y"</span> (<span class="type">EVar</span> <span class="string">"m"</span>)</div><div class="line">                 (<span class="type">ELet</span> <span class="string">"x"</span> (<span class="type">EApp</span> (<span class="type">EVar</span> <span class="string">"y"</span>) (<span class="type">ELit</span> (<span class="type">LBool</span> <span class="type">True</span>)))</div><div class="line">                       (<span class="type">EVar</span> <span class="string">"x"</span>)))</div><div class="line">       </div><div class="line"><span class="title">e6</span>  =  <span class="type">EApp</span> (<span class="type">ELit</span> (<span class="type">LInt</span> <span class="number">2</span>)) (<span class="type">ELit</span> (<span class="type">LInt</span> <span class="number">2</span>))</div></pre></td></tr></table></figure>
<p>下面这个简单的测试函数试图推断给定表达式的类型。如果成功了，它将打印出这个表达式和它的类型，否则，打印错误信息。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="title">test</span> :: <span class="type">Exp</span> -&gt; <span class="type">IO</span> ()</div><div class="line"><span class="title">test</span> e =</div><div class="line">    <span class="keyword">do</span>  (res, _) &lt;- runTI (typeInference <span class="type">Map</span>.empty e)</div><div class="line">        <span class="keyword">case</span> res <span class="keyword">of</span></div><div class="line">          <span class="type">Left</span> err  -&gt;  putStrLn $ show e ++ <span class="string">"\n "</span> ++ err ++ <span class="string">"\n"</span></div><div class="line">          <span class="type">Right</span> t   -&gt;  putStrLn $ show e ++ <span class="string">" :: "</span> ++ show t ++ <span class="string">"\n"</span></div></pre></td></tr></table></figure>
<h3 id="2-4-Main"><a href="#2-4-Main" class="headerlink" title="2.4 Main"></a>2.4 Main</h3><p>Main 只是简单地推断了所有示例表达式并且将它们和所推导出来的类型一同打印出来，如果失败，将打印错误信息。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">main</span> :: <span class="type">IO</span> ()</div><div class="line"><span class="title">main</span> = mapM_ test [e0, e1, e2, e3, e4, e5, e6]</div><div class="line"><span class="comment">-- |Collecting Constraints|</span></div><div class="line"><span class="comment">-- |main = mapM_ test' [e0, e1, e2, e3, e4, e5]|</span></div></pre></td></tr></table></figure>
<p>这就是这个类型推导算法的全部实现了。</p>
<h2 id="3-结论"><a href="#3-结论" class="headerlink" title="3. 结论"></a>3. 结论</h2><p>这些 Haskell 代码是一个自包含的 Algorithm W 实现。你可以随意使用、扩展这些代码，让它能够支持更好的错误信息、类型类、类型注解等等。最终你也许会得到一个完整地 Haskell 的类型检查器。</p>
<h2 id="4-参考"><a href="#4-参考" class="headerlink" title="4. 参考"></a>4. 参考</h2><p>[1] Copied from <a href="http://www.grabmueller.de/martin/www/pub/AlgorithmW.en.html" target="_blank" rel="external">http://www.grabmueller.de/martin/www/pub/AlgorithmW.en.html</a> and edited by Wei Hu. Unfortunately the bibliography is missing. </p>
<p>[2] The most helpful references are <a href="http://www.cs.uu.nl/research/techreps/repo/CS-2002/2002-031.pdf" target="_blank" rel="external">http://www.cs.uu.nl/research/techreps/repo/CS-2002/2002-031.pdf</a> Generalizing Hindley-Milner Type Inference Algorithms, and Chapter 22 of TAPL.</p>
<p>[3] A Cornell course touchs on this topic and gives an OCaml implementation. <a href="http://www.cs.cornell.edu/Courses/cs3110/2009fa/lectures/lec26a.htm" target="_blank" rel="external">http://www.cs.cornell.edu/Courses/cs3110/2009fa/lectures/lec26a.htm</a></p>
<h2 id="附录-A"><a href="#附录-A" class="headerlink" title="附录 A"></a>附录 A</h2><p>本附录提供了 pretty-printing 方法和 type 的 Show 类型类实例。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Type</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prType x)</div><div class="line"><span class="title">prType</span>             ::  <span class="type">Type</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prType</span> (<span class="type">TVar</span> n)    =   <span class="type">PP</span>.text n</div><div class="line"><span class="title">prType</span> <span class="type">TInt</span>        =   <span class="type">PP</span>.text <span class="string">"Int"</span></div><div class="line"><span class="title">prType</span> <span class="type">TBool</span>       =   <span class="type">PP</span>.text <span class="string">"Bool"</span></div><div class="line"><span class="title">prType</span> (<span class="type">TFun</span> t s)  =   prParenType t <span class="type">PP</span>.&lt;+&gt; <span class="type">PP</span>.text <span class="string">"-&gt;"</span> <span class="type">PP</span>.&lt;+&gt; prType s</div><div class="line"><span class="title">prParenType</span>     ::  <span class="type">Type</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prParenType</span>  t  =   <span class="keyword">case</span> t <span class="keyword">of</span></div><div class="line">                      <span class="type">TFun</span> _ _  -&gt; <span class="type">PP</span>.parens (prType t)</div><div class="line">                      _         -&gt; prType t</div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Exp</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prExp x)</div><div class="line"><span class="title">prExp</span>                  ::  <span class="type">Exp</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prExp</span> (<span class="type">EVar</span> name)      =   <span class="type">PP</span>.text name</div><div class="line"><span class="title">prExp</span> (<span class="type">ELit</span> lit)       =   prLit lit</div><div class="line"><span class="title">prExp</span> (<span class="type">ELet</span> x b body)  =   <span class="type">PP</span>.text <span class="string">"let"</span> <span class="type">PP</span>.&lt;+&gt; </div><div class="line">                           <span class="type">PP</span>.text x <span class="type">PP</span>.&lt;+&gt; <span class="type">PP</span>.text <span class="string">"="</span> <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                           prExp b <span class="type">PP</span>.&lt;+&gt; <span class="type">PP</span>.text <span class="string">"in"</span> <span class="type">PP</span>.$$</div><div class="line">                           <span class="type">PP</span>.nest <span class="number">2</span> (prExp body)</div><div class="line"><span class="title">prExp</span> (<span class="type">EApp</span> e1 e2)     =   prExp e1 <span class="type">PP</span>.&lt;+&gt; prParenExp e2</div><div class="line"><span class="title">prExp</span> (<span class="type">EAbs</span> n e)       =   <span class="type">PP</span>.char '\\' <span class="type">PP</span>.&lt;&gt; <span class="type">PP</span>.text n <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                           <span class="type">PP</span>.text <span class="string">"-&gt;"</span> <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                           prExp e</div><div class="line">                                                                   </div><div class="line"><span class="title">prParenExp</span>    ::  <span class="type">Exp</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prParenExp</span> t  =   <span class="keyword">case</span> t <span class="keyword">of</span></div><div class="line">                    <span class="type">ELet</span> _ _ _  -&gt; <span class="type">PP</span>.parens (prExp t)</div><div class="line">                    <span class="type">EApp</span> _ _    -&gt; <span class="type">PP</span>.parens (prExp t)</div><div class="line">                    <span class="type">EAbs</span> _ _    -&gt; <span class="type">PP</span>.parens (prExp t)</div><div class="line">                    _           -&gt; prExp t</div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Lit</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prLit x)</div><div class="line"><span class="title">prLit</span>            ::  <span class="type">Lit</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prLit</span> (<span class="type">LInt</span> i)   =   <span class="type">PP</span>.integer i</div><div class="line"><span class="title">prLit</span> (<span class="type">LBool</span> b)  =   <span class="keyword">if</span> b <span class="keyword">then</span> <span class="type">PP</span>.text <span class="string">"True"</span> <span class="keyword">else</span> <span class="type">PP</span>.text <span class="string">"False"</span></div><div class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">Scheme</span> <span class="keyword">where</span></span></div><div class="line">    showsPrec _ x = shows (prScheme x)</div><div class="line"><span class="title">prScheme</span>                  ::  <span class="type">Scheme</span> -&gt; <span class="type">PP</span>.<span class="type">Doc</span></div><div class="line"><span class="title">prScheme</span> (<span class="type">Scheme</span> vars t)  =   <span class="type">PP</span>.text <span class="string">"All"</span> <span class="type">PP</span>.&lt;+&gt;</div><div class="line">                              <span class="type">PP</span>.hcat </div><div class="line">                                (<span class="type">PP</span>.punctuate <span class="type">PP</span>.comma (map <span class="type">PP</span>.text vars))</div><div class="line">                              <span class="type">PP</span>.&lt;&gt; <span class="type">PP</span>.text <span class="string">"."</span> <span class="type">PP</span>.&lt;+&gt; prType t</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/03/16/Shikaiia-Design/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/16/Shikaiia-Design/" itemprop="url">
                  Shikaiia-Design
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-16T22:56:52+08:00">
                2017-03-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/16/Shikaiia-Design/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/16/Shikaiia-Design/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>The game I want to play.</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/03/16/Shikaiia-Design/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/03/09/Fancy-and-Trivial/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/09/Fancy-and-Trivial/" itemprop="url">
                  Fancy and Trivial
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-09T23:59:25+08:00">
                2017-03-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/09/Fancy-and-Trivial/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/09/Fancy-and-Trivial/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>一种假象。</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/03/09/Fancy-and-Trivial/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/01/15/Books/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/15/Books/" itemprop="url">
                  Books
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-15T03:47:33+08:00">
                2017-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/15/Books/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/15/Books/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<ol>
<li>SICP</li>
<li>CSAPP</li>
<li>Learn You a Haskell in Great Good</li>
<li>Types and Programming Languages</li>
<li>Kotlin Specification</li>
</ol>
<hr>
<ol>
<li>Introduction to Lambda Calculus</li>
<li>Introduction to Algorithm</li>
</ol>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/01/14/Make-a-Lisp-Step-0/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/14/Make-a-Lisp-Step-0/" itemprop="url">
                  Make a Lisp Step 0
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-14T17:20:36+08:00">
                2017-01-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/14/Make-a-Lisp-Step-0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/14/Make-a-Lisp-Step-0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Make A Lisp!</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/01/14/Make-a-Lisp-Step-0/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/01/10/也许你们不知道，但-Kotlin-也像-Lisp/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/10/也许你们不知道，但-Kotlin-也像-Lisp/" itemprop="url">
                  也许你们不知道，但 Kotlin 也像 Lisp
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-10T01:10:07+08:00">
                2017-01-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/10/也许你们不知道，但-Kotlin-也像-Lisp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/10/也许你们不知道，但-Kotlin-也像-Lisp/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>老文重发。<br>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/01/10/也许你们不知道，但-Kotlin-也像-Lisp/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/01/09/我推荐的学习方法/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/我推荐的学习方法/" itemprop="url">
                  我推荐的学习方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-09T23:07:47+08:00">
                2017-01-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/09/我推荐的学习方法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/09/我推荐的学习方法/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>众所周知，上课的效率是极度低下的，复习考试（除了数学课），对学习什么知识也基本是没用的。</p>
<p>那么正确的学习方法是什么呢？那就是自学。</p>
<p>遇到不懂的地方怎么办呢？如果思考了很久还没有弄懂的话，建议询问他人（包括搜索引擎）。如果还是感觉半懂不懂的，我建议暂时放下，以后再回头看看，往往更可能弄懂。因为这个时候你很可能陷入了误区，或者是你的知识体系还没有牢固到准备接受这块知识。至少于我而言，大部分时候我在有更多知识后回头看这些问题，发现当时没弄懂的原因都是这样。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/01/04/Introduction-to-Type-System/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/04/Introduction-to-Type-System/" itemprop="url">
                  Introduction to Type System
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-04T01:02:11+08:00">
                2017-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/04/Introduction-to-Type-System/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/04/Introduction-to-Type-System/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>看完你也不会有收获的类型系统笔记</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/01/04/Introduction-to-Type-System/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lingsamuel.github.io/2017/01/04/Projects-in-Winter-Vacation/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kisaragi Sarasa">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hakurei Shrine">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hakurei Shrine" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/04/Projects-in-Winter-Vacation/" itemprop="url">
                  Projects in Winter Vacation
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-04T00:52:43+08:00">
                2017-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/04/Projects-in-Winter-Vacation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/01/04/Projects-in-Winter-Vacation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Flags</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/01/04/Projects-in-Winter-Vacation/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Kisaragi Sarasa" />
          <p class="site-author-name" itemprop="name">Kisaragi Sarasa</p>
          <p class="site-description motion-element" itemprop="description">Broomie of Hakurei Shrine.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">18</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lingsamuel" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://yejingchen.github.io" title="PrincessSweet" target="_blank">PrincessSweet</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zccz14.com/" title="zccz14" target="_blank">zccz14</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kisaragi Sarasa</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'lingsamuel-github-io';
      var disqus_identifier = 'index.html';

      var disqus_title = "";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      

    </script>
  





  
  

  

  

  

  


</body>
</html>
